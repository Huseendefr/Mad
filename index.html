<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­ÙÙŠØ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' },
                    gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' }
                }
            }
        }
    }
</script>

<style>
    * { font-family: 'Cairo', sans-serif; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%); min-height: 100vh; }
    
    .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 8px 32px rgba(22,163,74,0.1); }
    .glass-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border: 1px solid rgba(22,163,74,0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
    
    .student-card { transition: all 0.3s ease; border: 3px solid transparent; }
    .student-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(22,163,74,0.15); border-color: rgba(22,163,74,0.3); }
    .student-card.selected { background: linear-gradient(135deg, rgba(22,163,74,0.15), rgba(34,197,94,0.08)); border-color: #22c55e; box-shadow: 0 10px 30px rgba(22,163,74,0.25); }
    .student-card.recorded { border-color: #fbbf24; background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05)); }
    .student-card.absent { opacity: 0.6; border-color: #ef4444; background: rgba(239,68,68,0.05); }
    
    .tab-btn { transition: all 0.3s ease; position: relative; }
    .tab-btn.active { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 4px 15px rgba(22,163,74,0.4); }
    .tab-btn:not(.active):hover { background: rgba(22,163,74,0.1); }
    
    .atte-btn { transition: all 0.3s ease; border: 2px solid #e5e7eb; }
    .atte-btn:hover { transform: scale(1.05); }
    .atte-btn.selected { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .atte-btn.present.selected { background: #22c55e; border-color: #22c55e; color: white; }
    .atte-btn.absent-btn.selected { background: #ef4444; border-color: #ef4444; color: white; }
    .atte-btn.late.selected { background: #f59e0b; border-color: #f59e0b; color: white; }
    .atte-btn.excused.selected { background: #8b5cf6; border-color: #8b5cf6; color: white; }
    
    .grade-btn { transition: all 0.3s ease; border: 2px solid #e5e7eb; min-width: 70px; }
    .grade-btn:hover { transform: scale(1.05); }
    .grade-btn.selected { transform: scale(1.08); }
    .grade-btn.excellent.selected { background: linear-gradient(135deg, #22c55e, #16a34a); border-color: #22c55e; color: white; }
    .grade-btn.good.selected { background: linear-gradient(135deg, #3b82f6, #2563eb); border-color: #3b82f6; color: white; }
    .grade-btn.acceptable.selected { background: linear-gradient(135deg, #f59e0b, #d97706); border-color: #f59e0b; color: white; }
    .grade-btn.weak.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #ef4444; color: white; }
    
    .deduct-btn { transition: all 0.2s ease; }
    .deduct-btn:hover { transform: scale(1.1); }
    .deduct-btn:active { transform: scale(0.95); }
    
    .save-btn { background: linear-gradient(135deg, #22c55e, #16a34a); transition: all 0.3s ease; }
    .save-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(22,163,74,0.4); }
    .save-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    
    select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }
    
    .toast { transform: translateY(100px); opacity: 0; transition: all 0.4s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #22c55e; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .book-bg { position: absolute; bottom: 20px; left: 20px; opacity: 0.05; font-size: 150px; color: #22c55e; transform: rotate(10deg); pointer-events: none; }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 10px; }
    
    .summary-table th { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .summary-table tr:nth-child(even) { background: rgba(22,163,74,0.05); }
    .summary-table tr:hover { background: rgba(22,163,74,0.1); }
    
    .points-display { font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #22c55e, #16a34a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .points-display.negative { background: linear-gradient(135deg, #ef4444, #dc2626); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    
    .filter-btn { transition: all 0.3s ease; }
    .filter-btn.active { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .filter-btn:not(.active):hover { background: rgba(22,163,74,0.1); }
    
    .last-lesson-hint { background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(37,99,235,0.05)); border: 1px solid rgba(59,130,246,0.2); }
</style>

</head>
<body class="min-h-screen p-4 md:p-6">

<div class="max-w-7xl mx-auto">
    
    <div class="glass rounded-2xl p-4 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-book-quran text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©</h1>
                <p class="text-sm text-gray-500">Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div id="dataStatus" class="flex items-center gap-2 text-sm text-gray-500">
                <i class="fas fa-database"></i>
                <span id="recordsCount">0 Ø³Ø¬Ù„</span>
            </div>
            <div class="h-6 w-px bg-gray-300"></div>
            <label class="text-sm font-medium text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="selectedDate" class="px-4 py-2 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium">
        </div>
    </div>
    
    <div class="flex gap-2 mb-6 flex-wrap justify-center">
        <button class="tab-btn active px-6 py-3 rounded-xl font-bold flex items-center gap-2" data-tab="entry" onclick="switchTab('entry')">
            <i class="fas fa-edit"></i>
            <span>Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
        </button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold flex items-center gap-2" data-tab="reports" onclick="switchTab('reports')">
            <i class="fas fa-chart-line"></i>
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
        </button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold flex items-center gap-2" data-tab="summary" onclick="switchTab('summary')">
            <i class="fas fa-list-check"></i>
            <span>Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</span>
        </button>
    </div>
    
    <div id="tabContent">
        
        <div id="entryTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-5">
                    <div class="glass rounded-2xl p-6 relative overflow-hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-users text-primary-500"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                            <span id="studentsCount" class="text-sm font-normal text-gray-500 mr-auto">(0 Ø·Ø§Ù„Ø¨)</span>
                        </h2>
                        
                        <div id="loadingStudents" class="flex justify-center items-center py-10">
                            <div class="loader"></div>
                            <span class="mr-3 text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
                        </div>
                        
                        <div id="studentsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[500px] overflow-y-auto hidden"></div>
                        
                        <i class="fas fa-book-open book-bg"></i>
                    </div>
                </div>
                
                <div class="lg:col-span-7">
                    <div class="glass rounded-2xl p-6 relative">
                        
                        <div id="formHeader" class="mb-6">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-user-edit text-primary-500"></i>
                                <span id="formTitle">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡</span>
                            </h2>
                            <p id="formSubtitle" class="text-sm text-gray-500 mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                        </div>
                        
                        <form id="entryForm" class="space-y-6 hidden">
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-3">
                                    <i class="fas fa-clipboard-check text-primary-500 ml-1"></i>
                                    Ø§Ù„Ø­Ø¶ÙˆØ±
                                </label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button type="button" class="atte-btn present py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="Ø­Ø§Ø¶Ø±" data-points="5" onclick="selectAttendance(this)">
                                        <i class="fas fa-check block text-lg mb-1"></i>
                                        Ø­Ø§Ø¶Ø±
                                        <span class="block text-xs text-gray-400">+5</span>
                                    </button>
                                    <button type="button" class="atte-btn absent-btn py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="ØºØ§Ø¦Ø¨" data-points="0" onclick="selectAttendance(this)">
                                        <i class="fas fa-times block text-lg mb-1"></i>
                                        ØºØ§Ø¦Ø¨
                                        <span class="block text-xs text-gray-400">0</span>
                                    </button>
                                    <button type="button" class="atte-btn late py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="Ù…ØªØ£Ø®Ø±" data-points="3" onclick="selectAttendance(this)">
                                        <i class="fas fa-clock block text-lg mb-1"></i>
                                        Ù…ØªØ£Ø®Ø±
                                        <span class="block text-xs text-gray-400">+3</span>
                                    </button>
                                    <button type="button" class="atte-btn excused py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="Ù…Ø³ØªØ£Ø°Ù†" data-points="2" onclick="selectAttendance(this)">
                                        <i class="fas fa-hand block text-lg mb-1"></i>
                                        Ù…Ø³ØªØ£Ø°Ù†
                                        <span class="block text-xs text-gray-400">+2</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="gradesSection" class="space-y-6 hidden">
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-book text-primary-500 ml-1"></i>
                                        Ø§Ù„Ø¯Ø±Ø³
                                    </label>
                                    <select id="lessonSelect" class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium appearance-none">
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³ --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-star text-primary-500 ml-1"></i>
                                        Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù†
                                    </label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button type="button" class="grade-btn excellent py-3 rounded-xl font-medium text-sm" data-value="10" data-type="save" onclick="selectGrade(this, 'save')">
                                            <span class="block text-lg font-bold">10</span>
                                            Ù…Ù…ØªØ§Ø²
                                        </button>
                                        <button type="button" class="grade-btn good py-3 rounded-xl font-medium text-sm" data-value="8" data-type="save" onclick="selectGrade(this, 'save')">
                                            <span class="block text-lg font-bold">8</span>
                                            Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹
                                        </button>
                                        <button type="button" class="grade-btn acceptable py-3 rounded-xl font-medium text-sm" data-value="6" data-type="save" onclick="selectGrade(this, 'save')">
                                            <span class="block text-lg font-bold">6</span>
                                            Ù…Ù‚Ø¨ÙˆÙ„
                                        </button>
                                        <button type="button" class="grade-btn weak py-3 rounded-xl font-medium text-sm" data-value="4" data-type="save" onclick="selectGrade(this, 'save')">
                                            <span class="block text-lg font-bold">4</span>
                                            Ø¥Ø¹Ø§Ø¯Ø©
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-redo text-primary-500 ml-1"></i>
                                        Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                                    </label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button type="button" class="grade-btn excellent py-3 rounded-xl font-medium text-sm" data-value="10" data-type="review" onclick="selectGrade(this, 'review')">
                                            <span class="block text-lg font-bold">10</span>
                                            Ù…Ù…ØªØ§Ø²
                                        </button>
                                        <button type="button" class="grade-btn good py-3 rounded-xl font-medium text-sm" data-value="8" data-type="review" onclick="selectGrade(this, 'review')">
                                            <span class="block text-lg font-bold">8</span>
                                            Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹
                                        </button>
                                        <button type="button" class="grade-btn acceptable py-3 rounded-xl font-medium text-sm" data-value="6" data-type="review" onclick="selectGrade(this, 'review')">
                                            <span class="block text-lg font-bold">6</span>
                                            Ù…Ù‚Ø¨ÙˆÙ„
                                        </button>
                                        <button type="button" class="grade-btn weak py-3 rounded-xl font-medium text-sm" data-value="4" data-type="review" onclick="selectGrade(this, 'review')">
                                            <span class="block text-lg font-bold">4</span>
                                            Ø¥Ø¹Ø§Ø¯Ø©
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-map-marker-alt text-primary-500 ml-1"></i>
                                        Ø£ÙŠÙ† ÙˆØµÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ
                                    </label>
                                    <div id="lastLessonHint" class="last-lesson-hint rounded-xl p-3 mb-2 hidden">
                                        <p class="text-sm text-blue-700">
                                            <i class="fas fa-history ml-1"></i>
                                            Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù…Ø³Ø¬Ù„: <span id="lastLessonText" class="font-bold"></span>
                                        </p>
                                    </div>
                                    <input type="text" id="currentLessonInput" placeholder="Ù…Ø«Ø§Ù„: ØµÙØ­Ø© 25 - Ø¯Ø±Ø³ Ø§Ù„ÙØªØ­Ø©" class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-calculator text-gold-500 ml-1"></i>
                                        Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­ÙÙŠØ²
                                        <span class="text-xs text-gray-400 font-normal">(ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</span>
                                    </label>
                                    
                                    <div class="glass-card rounded-2xl p-4">
                                        <div class="text-center mb-4">
                                            <span id="pointsDisplay" class="points-display">0</span>
                                            <p class="text-xs text-gray-500 mt-1">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-2 text-center text-xs mb-4 pb-4 border-b border-gray-200">
                                            <div>
                                                <span class="text-gray-500">Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                                                <p id="attendancePoints" class="font-bold text-green-600">+0</p>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</span>
                                                <p id="savePoints" class="font-bold text-blue-600">+0</p>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                                <p id="reviewPoints" class="font-bold text-purple-600">+0</p>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <p class="text-xs text-gray-500 mb-2 text-center">Ø®ØµÙ… Ù†Ù‚Ø§Ø·:</p>
                                            <div class="flex justify-center gap-3">
                                                <button type="button" class="deduct-btn w-12 h-12 rounded-full bg-red-100 text-red-600 font-bold text-sm hover:bg-red-200" onclick="deductPoints(1)">-1</button>
                                                <button type="button" class="deduct-btn w-12 h-12 rounded-full bg-red-200 text-red-700 font-bold text-sm hover:bg-red-300" onclick="deductPoints(3)">-3</button>
                                                <button type="button" class="deduct-btn w-12 h-12 rounded-full bg-red-300 text-red-800 font-bold text-sm hover:bg-red-400" onclick="deductPoints(5)">-5</button>
                                                <button type="button" class="deduct-btn w-12 h-12 rounded-full bg-gray-200 text-gray-600 font-bold text-lg hover:bg-gray-300" onclick="resetDeductions()" title="Ø¥Ù„ØºØ§Ø¡">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </div>
                                            <p id="deductionsDisplay" class="text-xs text-red-500 text-center mt-2 hidden">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: <span>0</span></p>
                                        </div>
                                    </div>
                                    
                                    <input type="hidden" id="pointsInput" value="0">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-comment text-primary-500 ml-1"></i>
                                        Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                    </label>
                                    <textarea id="notesInput" rows="2" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..." class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition resize-none"></textarea>
                                </div>
                            </div>
                            
                            <button type="submit" id="saveBtn" class="save-btn w-full py-4 rounded-xl text-white font-bold text-lg flex items-center justify-center gap-2" disabled>
                                <i class="fas fa-save"></i>
                                <span>Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                            </button>
                        </form>
                        
                        <div id="selectPrompt" class="text-center py-16">
                            <i class="fas fa-hand-pointer text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-400 text-lg">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="reportsTab" class="tab-content hidden">
            <div class="glass rounded-2xl p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-line text-primary-500"></i>
                        ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportReports('pdf')" class="px-4 py-2 bg-red-500 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-red-600 transition">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button onclick="exportReports('excel')" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-green-700 transition">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-1">
                        <select id="reportStudentSelect" onchange="loadStudentReport()" class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium appearance-none">
                            <option value="">-- Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ --</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="filter-btn active px-4 py-2 rounded-xl font-medium text-sm border-2 border-gray-200" data-period="7" onclick="setReportPeriod(7)">
                            Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
                        </button>
                        <button class="filter-btn px-4 py-2 rounded-xl font-medium text-sm border-2 border-gray-200" data-period="30" onclick="setReportPeriod(30)">
                            Ø¢Ø®Ø± Ø´Ù‡Ø±
                        </button>
                        <button class="filter-btn px-4 py-2 rounded-xl font-medium text-sm border-2 border-gray-200" data-period="all" onclick="setReportPeriod('all')">
                            Ø§Ù„ÙƒÙ„
                        </button>
                    </div>
                </div>
                
                <div id="reportContentToExport">
                    <div id="reportChartContainer" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-gray-700 mb-4">ØªÙ‚Ø¯Ù… Ø§Ù„Ø¥ØªÙ‚Ø§Ù† ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                                <canvas id="progressChart" height="250"></canvas>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-gray-700 mb-4">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                                <canvas id="attendanceChart" height="250"></canvas>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-calendar-check text-3xl text-primary-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statAttendance">--%</p>
                                <p class="text-sm text-gray-500">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                            </div>
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-star text-3xl text-blue-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statSave">--</p>
                                <p class="text-sm text-gray-500">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</p>
                            </div>
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-redo text-3xl text-purple-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statReview">--</p>
                                <p class="text-sm text-gray-500">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                            </div>
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-coins text-3xl text-gold-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statPoints">--</p>
                                <p class="text-sm text-gray-500">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="font-bold text-gray-700 mb-4">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
                            <div class="overflow-x-auto">
                                <table class="summary-table w-full rounded-xl overflow-hidden">
                                    <thead>
                                        <tr>
                                            <th class="py-3 px-4 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th class="py-3 px-4 text-center">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                                            <th class="py-3 px-4 text-right">Ø§Ù„Ø¯Ø±Ø³</th>
                                            <th class="py-3 px-4 text-center">Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</th>
                                            <th class="py-3 px-4 text-center">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                                            <th class="py-3 px-4 text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                            <th class="py-3 px-4 text-right">ÙˆØµÙ„ Ø¥Ù„Ù‰</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="noReportData" class="text-center py-16">
                    <i class="fas fa-chart-pie text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-400 text-lg">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ±Ù‡</p>
                </div>
            </div>
        </div>
        
        <div id="summaryTab" class="tab-content hidden">
            <div class="glass rounded-2xl p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-list-check text-primary-500"></i>
                        Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…
                        <span id="summaryDate" class="text-sm font-normal text-gray-500"></span>
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportSummary('pdf')" class="px-4 py-2 bg-red-500 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-red-600 transition">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button onclick="exportSummary('excel')" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-green-700 transition">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-primary-600" id="summaryTotal">0</p>
                        <p class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-green-600" id="summaryPresent">0</p>
                        <p class="text-xs text-gray-500">Ø­Ø§Ø¶Ø±</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-red-500" id="summaryAbsent">0</p>
                        <p class="text-xs text-gray-500">ØºØ§Ø¦Ø¨</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-yellow-500" id="summaryLate">0</p>
                        <p class="text-xs text-gray-500">Ù…ØªØ£Ø®Ø±</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-purple-500" id="summaryExcused">0</p>
                        <p class="text-xs text-gray-500">Ù…Ø³ØªØ£Ø°Ù†</p>
                    </div>
                </div>
                
                <div class="overflow-x-auto" id="summaryTableContainer">
                    <table class="summary-table w-full rounded-xl overflow-hidden" id="summaryTable">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 text-right">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th class="py-3 px-4 text-center">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                                <th class="py-3 px-4 text-right">Ø§Ù„Ø¯Ø±Ø³</th>
                                <th class="py-3 px-4 text-center">Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</th>
                                <th class="py-3 px-4 text-center">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                                <th class="py-3 px-4 text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                <th class="py-3 px-4 text-right">ÙˆØµÙ„ Ø¥Ù„Ù‰</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <tr>
                                <td colspan="7" class="py-10 text-center text-gray-400">
                                    <i class="fas fa-inbox text-4xl mb-2 block"></i>
                                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast fixed bottom-6 left-6 right-6 md:left-auto md:right-6 md:w-96 bg-primary-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 z-50">
    <i id="toastIcon" class="fas fa-check-circle text-2xl"></i>
    <span id="toastMessage" class="font-medium">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</span>
</div>

<script>
    // ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
    const API_BASE = 'https://n8n.srv1238717.hstgr.cloud/webhook';
    const GET_DATA_URL = `${API_BASE}/Get-data`;
    const SUBMIT_URL = `${API_BASE}/Submit-daily`;
    
    let students = [];
    let lessons = [];
    let selectedStudent = null;
    let allRecords = [];
    let reportPeriod = 7;
    
    let formData = {
        attendance: null,
        attendancePoints: 0,
        lesson: null,
        saveScore: null,
        savePoints: 0,
        reviewScore: null,
        reviewPoints: 0,
        deductions: 0,
        totalPoints: 0,
        currentLesson: '',
        notes: ''
    };
    
    // ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
    document.addEventListener('DOMContentLoaded', async function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('selectedDate').value = today;
        
        await loadData();
        
        document.getElementById('entryForm').addEventListener('submit', handleSubmit);
        document.getElementById('lessonSelect').addEventListener('change', validateForm);
        document.getElementById('selectedDate').addEventListener('change', handleDateChange);
    });
    
    // ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ====================
    function handleDateChange() {
        selectedStudent = null;
        resetForm();
        
        document.getElementById('selectPrompt').classList.remove('hidden');
        document.getElementById('entryForm').classList.add('hidden');
        document.getElementById('formTitle').textContent = 'Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡';
        document.getElementById('formSubtitle').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
        document.getElementById('lastLessonHint').classList.add('hidden');
        
        renderStudents();
        updateSummary();
    }
    
    // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
    async function loadData() {
        try {
            const response = await fetch(GET_DATA_URL);
            const data = await response.json();
            
            // ğŸ” ØªØ´Ø®ÙŠØµ: Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Console
            console.log('ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', data.length);
            console.log('ğŸ“‹ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', data.slice(0, 5));
            
            // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„Ø¯ÙŠÙ‡Ù… Student_na ÙˆÙ„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… ØªØ§Ø±ÙŠØ®)
            students = data.filter(item => item.Student_na && !item.date && !item.Date);
            
            // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³
            lessons = data.filter(item => item.lesson_name);
            
            // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Ø§Ù„Ø¨Ø­Ø« Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø­Ù‚ÙˆÙ„
            allRecords = data.filter(item => {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø£ÙŠ Ø§Ø³Ù…
                const hasDate = item.date || item.Date || item.DATE;
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø£ÙŠ Ø§Ø³Ù…
                const hasAtte = item.atte || item.Atte || item.ATTE || item.attendance || item.Attendance;
                return hasDate && hasAtte;
            }).map(r => ({
                student_na: r.student_na || r.Student_na || r.studentName || '',
                lesson_na: r.lesson_na || r.Lesson_na || r.lessonName || '',
                save_sc: r.save_sc || r.Save_sc || r.saveScore || 0,
                review_sc: r.review_sc || r.Review_sc || r.reviewScore || 0,
                points: r.points || r.Points || 0,
                atte: r.atte || r.Atte || r.ATTE || r.attendance || r.Attendance || '',
                notes: r.notes || r.Notes || '',
                date: r.date || r.Date || r.DATE || '',
                current_lesson: r.current_lesson || r.Current_lesson || r.currentLesson || ''
            }));
            
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„:', students.length, 'Ø·Ø§Ù„Ø¨ |', lessons.length, 'Ø¯Ø±Ø³ |', allRecords.length, 'Ø³Ø¬Ù„');
            console.log('ğŸ“Š Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', allRecords.slice(0, 3));
            
            document.getElementById('studentsCount').textContent = `(${students.length} Ø·Ø§Ù„Ø¨)`;
            document.getElementById('recordsCount').textContent = `${allRecords.length} Ø³Ø¬Ù„`;
            
            renderStudents();
            populateLessons();
            populateReportStudents();
            updateSummary();
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    }
    
    // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ ====================
    function renderStudents() {
        const grid = document.getElementById('studentsGrid');
        const loading = document.getElementById('loadingStudents');
        const currentDate = document.getElementById('selectedDate').value;
        
        loading.classList.add('hidden');
        grid.classList.remove('hidden');
        
        const todayRecords = allRecords.filter(r => r.date === currentDate);
        
        grid.innerHTML = students.map(student => {
            const record = todayRecords.find(r => r.student_na === student.Student_na);
            let statusClass = '';
            let statusIcon = '';
            
            if (record) {
                if (record.atte === 'ØºØ§Ø¦Ø¨') {
                    statusClass = 'absent';
                    statusIcon = '<i class="fas fa-times-circle text-red-500 absolute top-1 left-1"></i>';
                } else {
                    statusClass = 'recorded';
                    statusIcon = '<i class="fas fa-check-circle text-yellow-500 absolute top-1 left-1"></i>';
                }
            }
            
            return `
                <div class="student-card glass-card rounded-xl p-4 cursor-pointer text-center relative ${statusClass} ${selectedStudent?.id === student.id ? 'selected' : ''}" 
                     onclick="selectStudent(${student.id})">
                    ${statusIcon}
                    <div class="w-12 h-12 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold text-lg">
                        ${student.Student_na.charAt(0)}
                    </div>
                    <p class="font-bold text-gray-800 text-sm truncate">${student.Student_na}</p>
                    <p class="text-xs text-gray-500">${student.Student_lev || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                </div>
            `;
        }).join('');
    }
    
    // ==================== Ù…Ù„Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ====================
    function populateLessons() {
        const select = document.getElementById('lessonSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³ --</option>' + 
            lessons.map(lesson => `
                <option value="${lesson.lesson_name}">${lesson.lesson_name} (Øµ${lesson.page_number})</option>
            `).join('');
    }
    
    function populateReportStudents() {
        const select = document.getElementById('reportStudentSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ --</option>' + 
            students.map(student => `
                <option value="${student.Student_na}">${student.Student_na}</option>
            `).join('');
    }
    
    // ==================== Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø·Ø§Ù„Ø¨ ====================
    function getLastLessonForStudent(studentName) {
        const studentRecords = allRecords
            .filter(r => r.student_na === studentName && r.current_lesson)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (studentRecords.length > 0) {
            return studentRecords[0].current_lesson;
        }
        return null;
    }
    
    // ==================== Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ ====================
    function selectStudent(id) {
        selectedStudent = students.find(s => s.id === id);
        
        document.getElementById('formTitle').textContent = selectedStudent.Student_na;
        document.getElementById('formSubtitle').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${selectedStudent.Student_lev || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
        
        document.getElementById('selectPrompt').classList.add('hidden');
        document.getElementById('entryForm').classList.remove('hidden');
        
        resetForm();
        
        const lastLesson = getLastLessonForStudent(selectedStudent.Student_na);
        const lastLessonHint = document.getElementById('lastLessonHint');
        const lastLessonText = document.getElementById('lastLessonText');
        
        if (lastLesson) {
            lastLessonText.textContent = lastLesson;
            lastLessonHint.classList.remove('hidden');
        } else {
            lastLessonHint.classList.add('hidden');
        }
        
        renderStudents();
    }
    
    // ==================== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¶ÙˆØ± ====================
    function selectAttendance(btn) {
        document.querySelectorAll('.atte-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        formData.attendance = btn.dataset.value;
        formData.attendancePoints = parseInt(btn.dataset.points);
        
        const gradesSection = document.getElementById('gradesSection');
        if (formData.attendance === 'Ø­Ø§Ø¶Ø±' || formData.attendance === 'Ù…ØªØ£Ø®Ø±') {
            gradesSection.classList.remove('hidden');
        } else {
            gradesSection.classList.add('hidden');
            formData.saveScore = null;
            formData.savePoints = 0;
            formData.reviewScore = null;
            formData.reviewPoints = 0;
            document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('selected'));
        }
        
        calculateTotalPoints();
        validateForm();
    }
    
    // ==================== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯Ø±Ø¬Ø© ====================
    function selectGrade(btn, type) {
        document.querySelectorAll(`.grade-btn[data-type="${type}"]`).forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        const value = parseInt(btn.dataset.value);
        
        if (type === 'save') {
            formData.saveScore = value;
            formData.savePoints = (value >= 6) ? value : 0;
        } else {
            formData.reviewScore = value;
            formData.reviewPoints = (value >= 6) ? value : 0;
        }
        
        calculateTotalPoints();
        validateForm();
    }
    
    // ==================== Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· ====================
    function deductPoints(amount) {
        formData.deductions += amount;
        const deductionsDisplay = document.getElementById('deductionsDisplay');
        deductionsDisplay.classList.remove('hidden');
        deductionsDisplay.querySelector('span').textContent = formData.deductions;
        calculateTotalPoints();
    }
    
    function resetDeductions() {
        formData.deductions = 0;
        document.getElementById('deductionsDisplay').classList.add('hidden');
        calculateTotalPoints();
    }
    
    // ==================== Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ====================
    function calculateTotalPoints() {
        formData.totalPoints = formData.attendancePoints + formData.savePoints + formData.reviewPoints - formData.deductions;
        
        document.getElementById('attendancePoints').textContent = `+${formData.attendancePoints}`;
        document.getElementById('savePoints').textContent = `+${formData.savePoints}`;
        document.getElementById('reviewPoints').textContent = `+${formData.reviewPoints}`;
        
        const pointsDisplay = document.getElementById('pointsDisplay');
        pointsDisplay.textContent = formData.totalPoints;
        pointsDisplay.classList.toggle('negative', formData.totalPoints < 0);
        
        document.getElementById('pointsInput').value = formData.totalPoints;
    }
    
    // ==================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ====================
    function validateForm() {
        const saveBtn = document.getElementById('saveBtn');
        let isValid = false;
        
        if (formData.attendance === 'ØºØ§Ø¦Ø¨' || formData.attendance === 'Ù…Ø³ØªØ£Ø°Ù†') {
            isValid = true;
        } else if (formData.attendance === 'Ø­Ø§Ø¶Ø±' || formData.attendance === 'Ù…ØªØ£Ø®Ø±') {
            const lesson = document.getElementById('lessonSelect').value;
            isValid = lesson && formData.saveScore && formData.reviewScore;
        }
        
        saveBtn.disabled = !isValid;
    }
    
    // ==================== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
    async function handleSubmit(e) {
        e.preventDefault();
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="loader mx-auto"></div>';
        
        const payload = {
            student_na: selectedStudent.Student_na,
            lesson_na: document.getElementById('lessonSelect').value || '',
            save_sc: formData.saveScore || 0,
            review_sc: formData.reviewScore || 0,
            points: formData.totalPoints,
            atte: formData.attendance,
            notes: document.getElementById('notesInput').value,
            date: document.getElementById('selectedDate').value,
            current_lesson: document.getElementById('currentLessonInput').value
        };
        
        try {
            const response = await fetch(SUBMIT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (response.ok) {
                allRecords.push(payload);
                document.getElementById('recordsCount').textContent = `${allRecords.length} Ø³Ø¬Ù„`;
                
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ“', 'success');
                
                updateSummary();
                
                resetForm();
                selectedStudent = null;
                document.getElementById('selectPrompt').classList.remove('hidden');
                document.getElementById('entryForm').classList.add('hidden');
                document.getElementById('formTitle').textContent = 'Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡';
                document.getElementById('formSubtitle').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
                document.getElementById('lastLessonHint').classList.add('hidden');
                
                renderStudents();
                
            } else {
                showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£:', error);
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
        
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i><span>Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>';
    }
    
    // ==================== Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ====================
    function resetForm() {
        formData = {
            attendance: null,
            attendancePoints: 0,
            lesson: null,
            saveScore: null,
            savePoints: 0,
            reviewScore: null,
            reviewPoints: 0,
            deductions: 0,
            totalPoints: 0,
            currentLesson: '',
            notes: ''
        };
        
        document.querySelectorAll('.atte-btn, .grade-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('lessonSelect').value = '';
        document.getElementById('pointsInput').value = '0';
        document.getElementById('pointsDisplay').textContent = '0';
        document.getElementById('pointsDisplay').classList.remove('negative');
        document.getElementById('attendancePoints').textContent = '+0';
        document.getElementById('savePoints').textContent = '+0';
        document.getElementById('reviewPoints').textContent = '+0';
        document.getElementById('deductionsDisplay').classList.add('hidden');
        document.getElementById('currentLessonInput').value = '';
        document.getElementById('notesInput').value = '';
        document.getElementById('gradesSection').classList.add('hidden');
        document.getElementById('saveBtn').disabled = true;
    }
    
    // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ ====================
    function updateSummary() {
        const date = document.getElementById('selectedDate').value;
        document.getElementById('summaryDate').textContent = `- ${date}`;
        
        const dateRecords = allRecords.filter(r => r.date === date);
        
        document.getElementById('summaryTotal').textContent = students.length;
        document.getElementById('summaryPresent').textContent = dateRecords.filter(r => r.atte === 'Ø­Ø§Ø¶Ø±').length;
        document.getElementById('summaryAbsent').textContent = dateRecords.filter(r => r.atte === 'ØºØ§Ø¦Ø¨').length;
        document.getElementById('summaryLate').textContent = dateRecords.filter(r => r.atte === 'Ù…ØªØ£Ø®Ø±').length;
        document.getElementById('summaryExcused').textContent = dateRecords.filter(r => r.atte === 'Ù…Ø³ØªØ£Ø°Ù†').length;
        
        const tbody = document.getElementById('summaryTableBody');
        if (dateRecords.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-10 text-center text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-2 block"></i>
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = dateRecords.map(r => {
                let atteClass = '';
                if (r.atte === 'Ø­Ø§Ø¶Ø±') atteClass = 'text-green-600 bg-green-100';
                else if (r.atte === 'ØºØ§Ø¦Ø¨') atteClass = 'text-red-600 bg-red-100';
                else if (r.atte === 'Ù…ØªØ£Ø®Ø±') atteClass = 'text-yellow-600 bg-yellow-100';
                else atteClass = 'text-purple-600 bg-purple-100';
                
                return `
                    <tr>
                        <td class="py-3 px-4 font-medium">${r.student_na}</td>
                        <td class="py-3 px-4 text-center"><span class="px-3 py-1 rounded-full text-sm ${atteClass}">${r.atte}</span></td>
                        <td class="py-3 px-4 text-sm">${r.lesson_na || '-'}</td>
                        <td class="py-3 px-4 text-center font-bold">${r.save_sc || '-'}</td>
                        <td class="py-3 px-4 text-center font-bold">${r.review_sc || '-'}</td>
                        <td class="py-3 px-4 text-center"><span class="text-primary-600 font-bold">${r.points}</span></td>
                        <td class="py-3 px-4 text-sm text-gray-600">${r.current_lesson || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    // ==================== Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ====================
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tab) btn.classList.add('active');
        });
        
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        document.getElementById(`${tab}Tab`).classList.remove('hidden');
        
        if (tab === 'summary') updateSummary();
    }
    
    // ==================== ÙÙ„ØªØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ====================
    function setReportPeriod(period) {
        reportPeriod = period;
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.period == period) btn.classList.add('active');
        });
        
        loadStudentReport();
    }
    
    function getFilteredRecords(studentName) {
        let filtered = allRecords.filter(r => r.student_na === studentName);
        
        if (reportPeriod !== 'all') {
            const today = new Date();
            const startDate = new Date();
            startDate.setDate(today.getDate() - reportPeriod);
            
            filtered = filtered.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate >= startDate && recordDate <= today;
            });
        }
        
        return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
    }
    
    // ==================== ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ====================
    function loadStudentReport() {
        const studentName = document.getElementById('reportStudentSelect').value;
        const container = document.getElementById('reportChartContainer');
        const noData = document.getElementById('noReportData');
        
        if (!studentName) {
            container.classList.add('hidden');
            noData.classList.remove('hidden');
            noData.querySelector('p').textContent = 'Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ±Ù‡';
            return;
        }
        
        const studentRecords = getFilteredRecords(studentName);
        
        if (studentRecords.length === 0) {
            container.classList.add('hidden');
            noData.classList.remove('hidden');
            noData.querySelector('p').textContent = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ "${studentName}" ÙÙŠ ${reportPeriod === 'all' ? 'ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª' : `Ø¢Ø®Ø± ${reportPeriod} ÙŠÙˆÙ…`}`;
            
            document.getElementById('statAttendance').textContent = '--%';
            document.getElementById('statSave').textContent = '--';
            document.getElementById('statReview').textContent = '--';
            document.getElementById('statPoints').textContent = '--';
            return;
        }
        
        container.classList.remove('hidden');
        noData.classList.add('hidden');
        
        const totalRecords = studentRecords.length;
        
        const totalSave = studentRecords.reduce((sum, r) => sum + (parseFloat(r.save_sc) || 0), 0);
        const avgSave = (totalSave / totalRecords).toFixed(1);
        
        const totalReview = studentRecords.reduce((sum, r) => sum + (parseFloat(r.review_sc) || 0), 0);
        const avgReview = (totalReview / totalRecords).toFixed(1);
        
        const presentCount = studentRecords.filter(r => r.atte === 'Ø­Ø§Ø¶Ø±' || r.atte === 'Ù…ØªØ£Ø®Ø±').length;
        const attendanceRate = Math.round((presentCount / totalRecords) * 100);
        
        const totalPoints = studentRecords.reduce((sum, r) => sum + (parseInt(r.points) || 0), 0);
        
        document.getElementById('statAttendance').textContent = `${attendanceRate}%`;
        document.getElementById('statSave').textContent = avgSave;
        document.getElementById('statReview').textContent = avgReview;
        document.getElementById('statPoints').textContent = totalPoints;
        
        const labels = studentRecords.map(r => r.date ? r.date.split('T')[0] : r.date);
        const saveData = studentRecords.map(r => r.save_sc || 0);
        const reviewData = studentRecords.map(r => r.review_sc || 0);
        
        const attendanceCounts = [
            studentRecords.filter(r => r.atte === 'Ø­Ø§Ø¶Ø±').length,
            studentRecords.filter(r => r.atte === 'ØºØ§Ø¦Ø¨').length,
            studentRecords.filter(r => r.atte === 'Ù…ØªØ£Ø®Ø±').length,
            studentRecords.filter(r => r.atte === 'Ù…Ø³ØªØ£Ø°Ù†').length
        ];
        
        const ctx1 = document.getElementById('progressChart').getContext('2d');
        const ctx2 = document.getElementById('attendanceChart').getContext('2d');
        
        Chart.getChart(ctx1)?.destroy();
        Chart.getChart(ctx2)?.destroy();
        
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Ø§Ù„Ø¥ØªÙ‚Ø§Ù†', data: saveData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.4 },
                    { label: 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', data: reviewData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { min: 0, max: 10 } } }
        });
        
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Ø­Ø§Ø¶Ø±', 'ØºØ§Ø¦Ø¨', 'Ù…ØªØ£Ø®Ø±', 'Ù…Ø³ØªØ£Ø°Ù†'],
                datasets: [{ data: attendanceCounts, backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#8b5cf6'] }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        
        const reportTableBody = document.getElementById('reportTableBody');
        reportTableBody.innerHTML = studentRecords.map(r => {
            let atteClass = '';
            if (r.atte === 'Ø­Ø§Ø¶Ø±') atteClass = 'text-green-600 bg-green-100';
            else if (r.atte === 'ØºØ§Ø¦Ø¨') atteClass = 'text-red-600 bg-red-100';
            else if (r.atte === 'Ù…ØªØ£Ø®Ø±') atteClass = 'text-yellow-600 bg-yellow-100';
            else atteClass = 'text-purple-600 bg-purple-100';
            
            return `
                <tr>
                
                    <td class="py-3 px-4 font-medium">${r.date ? r.date.split('T')[0] : r.date}</td>
                    <td class="py-3 px-4 text-center"><span class="px-3 py-1 rounded-full text-sm ${atteClass}">${r.atte}</span></td>
                    <td class="py-3 px-4 text-sm">${r.lesson_na || '-'}</td>
                    <td class="py-3 px-4 text-center font-bold">${r.save_sc || '-'}</td>
                    <td class="py-3 px-4 text-center font-bold">${r.review_sc || '-'}</td>
                    <td class="py-3 px-4 text-center"><span class="text-primary-600 font-bold">${r.points}</span></td>
                    <td class="py-3 px-4 text-sm text-gray-600">${r.current_lesson || '-'}</td>
                </tr>
            `;
        }).join('');
    }
    
    // ==================== Ø§Ù„ØªØµØ¯ÙŠØ± ====================
    function exportReports(format) {
        const studentName = document.getElementById('reportStudentSelect').value;
        if (!studentName) {
            showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            return;
        }

        const date = new Date().toISOString().split('T')[0];
        const periodText = reportPeriod === 'all' ? 'Ø§Ù„ÙƒÙ„' : `${reportPeriod}ÙŠÙˆÙ…`;
        const fileName = `ØªÙ‚Ø±ÙŠØ±_${studentName}_${periodText}_${date}`;

        if (format === 'excel') {
            const studentRecords = getFilteredRecords(studentName);
            if (studentRecords.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(studentRecords);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨");
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel', 'success');
        } 
        else if (format === 'pdf') {
            const reportElement = document.getElementById('reportContentToExport');
            const opt = {
                margin: 1,
                filename: `${fileName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(reportElement).set(opt).save();
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF...', 'success');
        }
    }
    
    function exportSummary(format) {
        const date = document.getElementById('selectedDate').value;
        const fileName = `Ù…Ù„Ø®Øµ_Ø§Ù„ÙŠÙˆÙ…_${date}`;
        
        if (format === 'excel') {
            const recordsToExport = allRecords.filter(r => r.date === date);
            if (recordsToExport.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(recordsToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…");
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel', 'success');
        } 
        else if (format === 'pdf') {
            const element = document.getElementById('summaryTab');
            const opt = {
                margin: 0.5,
                filename: `${fileName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            html2pdf().from(element).set(opt).save();
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF...', 'success');
        }
    }
    
    // ==================== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const msg = document.getElementById('toastMessage');
        
        msg.textContent = message;
        
        toast.className = 'toast fixed bottom-6 left-6 right-6 md:left-auto md:right-6 md:w-96 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 z-50';
        
        if (type === 'success') {
            toast.classList.add('bg-primary-500');
            icon.className = 'fas fa-check-circle text-2xl';
        } else if (type === 'error') {
            toast.classList.add('bg-red-500');
            icon.className = 'fas fa-times-circle text-2xl';
        } else {
            toast.classList.add('bg-blue-500');
            icon.className = 'fas fa-info-circle text-2xl';
        }
        
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>

<!-- ==================== AI Chatbot Widget ==================== -->
<div id="aiWidget" class="fixed bottom-6 left-6 z-50 flex flex-col items-start gap-4" style="right: auto; left: 20px;">
    
    <button onclick="toggleChat()" class="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition duration-300 border-2 border-white">
        <i class="fas fa-robot"></i>
    </button>

    <div id="chatWindow" class="hidden bg-white rounded-2xl shadow-2xl w-80 md:w-96 h-[500px] flex-col border border-gray-200 overflow-hidden transition-all transform origin-bottom-left absolute bottom-20 left-0">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <i class="fas fa-sparkles text-yellow-300"></i>
                <span class="font-bold">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</span>
            </div>
            <button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-lg transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="chatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3">
            <div class="flex gap-2 justify-start">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 border border-indigo-200">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tr-none text-sm text-gray-700 shadow-sm max-w-[85%]">
                    Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…! Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø·Ø§Ù„Ø¨.
                </div>
            </div>
        </div>
        
        <div class="p-3 bg-white border-t border-gray-100">
            <form onsubmit="sendAiMessage(event)" class="flex gap-2">
                <input type="text" id="aiInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." class="flex-1 px-4 py-2 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm" autocomplete="off">
                <button type="submit" id="sendAiBtn" class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-indigo-700 transition shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const AI_WEBHOOK_URL = 'https://n8n.srv1238717.hstgr.cloud/webhook/ai-chat';

    function toggleChat() {
        const chatWin = document.getElementById('chatWindow');
        chatWin.classList.toggle('hidden');
        if (!chatWin.classList.contains('hidden')) {
            document.getElementById('aiInput').focus();
            setTimeout(() => scrollToBottom(), 100);
        }
    }

    async function sendAiMessage(e) {
        e.preventDefault();
        const input = document.getElementById('aiInput');
        const btn = document.getElementById('sendAiBtn');
        const userText = input.value.trim();

        if (!userText) return;

        appendMessage(userText, 'user');
        input.value = '';
        btn.disabled = true;
        
        const loadingId = appendLoading();
        setTimeout(() => scrollToBottom(), 50);

        try {
            const response = await fetch(AI_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    query: userText,
                    date: document.getElementById('selectedDate').value
                })
            });

            const data = await response.json();
            
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) loadingElement.remove();
            
            let reply = data.output || data.message || data.response || data.text || 
                       (typeof data === 'string' ? data : "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ÙÙ‡Ù… Ø§Ù„Ø±Ø¯.");
            
            appendMessage(reply, 'bot');
            setTimeout(() => scrollToBottom(), 50);

        } catch (error) {
            console.error('Ø®Ø·Ø£:', error);
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) loadingElement.remove();
            
            appendMessage("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ workflow Mad_AI", 'bot');
            setTimeout(() => scrollToBottom(), 50);
        }

        btn.disabled = false;
    }

    function appendMessage(text, sender) {
        const messages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        
        if (sender === 'user') {
            div.className = 'flex gap-2 justify-end';
            div.innerHTML = `<div class="bg-indigo-600 text-white p-3 rounded-2xl rounded-tl-none text-sm shadow-md max-w-[85%]">${text}</div>`;
        } else {
            div.className = 'flex gap-2 justify-start';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 border border-indigo-200 shrink-0">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tr-none text-sm text-gray-700 shadow-sm max-w-[85%] leading-relaxed whitespace-pre-wrap">${text}</div>
            `;
        }
        messages.appendChild(div);
    }

    function appendLoading() {
        const id = 'loading-' + Date.now();
        const messages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.id = id;
        div.className = 'flex gap-2 justify-start';
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 border border-indigo-200">
                <i class="fas fa-robot text-sm"></i>
            </div>
            <div class="bg-white border border-gray-200 p-4 rounded-2xl rounded-tr-none shadow-sm">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        `;
        messages.appendChild(div);
        return id;
    }

    function scrollToBottom() {
        const messages = document.getElementById('chatMessages');
        if (messages) {
            messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
        }
    }
</script>

</body>
</html>
