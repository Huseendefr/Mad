<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القاعدة المدنية - تسجيل الحضور والتحفيظ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' }
                    }
                }
            }
        }
    </script>
    
    <style>
        * { font-family: 'Cairo', sans-serif; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%); min-height: 100vh; }
        
        /* تأثير الزجاج */
        .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 8px 32px rgba(22,163,74,0.1); }
        .glass-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border: 1px solid rgba(22,163,74,0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        
        /* بطاقة الطالب */
        .student-card { transition: all 0.3s ease; border: 3px solid transparent; }
        .student-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(22,163,74,0.15); border-color: rgba(22,163,74,0.3); }
        .student-card.selected { background: linear-gradient(135deg, rgba(22,163,74,0.15), rgba(34,197,94,0.08)); border-color: #22c55e; box-shadow: 0 10px 30px rgba(22,163,74,0.25); }
        .student-card.recorded { border-color: #fbbf24; background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05)); }
        .student-card.absent { opacity: 0.6; border-color: #ef4444; background: rgba(239,68,68,0.05); }
        
        /* التبويبات */
        .tab-btn { transition: all 0.3s ease; position: relative; }
        .tab-btn.active { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 4px 15px rgba(22,163,74,0.4); }
        .tab-btn:not(.active):hover { background: rgba(22,163,74,0.1); }
        
        /* أزرار الحضور */
        .atte-btn { transition: all 0.3s ease; border: 2px solid #e5e7eb; }
        .atte-btn:hover { transform: scale(1.05); }
        .atte-btn.selected { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .atte-btn.present.selected { background: #22c55e; border-color: #22c55e; color: white; }
        .atte-btn.absent-btn.selected { background: #ef4444; border-color: #ef4444; color: white; }
        .atte-btn.late.selected { background: #f59e0b; border-color: #f59e0b; color: white; }
        .atte-btn.excused.selected { background: #8b5cf6; border-color: #8b5cf6; color: white; }
        
        /* أزرار التقييم */
        .grade-btn { transition: all 0.3s ease; border: 2px solid #e5e7eb; min-width: 70px; }
        .grade-btn:hover { transform: scale(1.05); }
        .grade-btn.selected { transform: scale(1.08); }
        .grade-btn.excellent.selected { background: linear-gradient(135deg, #22c55e, #16a34a); border-color: #22c55e; color: white; }
        .grade-btn.good.selected { background: linear-gradient(135deg, #3b82f6, #2563eb); border-color: #3b82f6; color: white; }
        .grade-btn.acceptable.selected { background: linear-gradient(135deg, #f59e0b, #d97706); border-color: #f59e0b; color: white; }
        .grade-btn.weak.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #ef4444; color: white; }
        
        /* زر الحفظ */
        .save-btn { background: linear-gradient(135deg, #22c55e, #16a34a); transition: all 0.3s ease; }
        .save-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(22,163,74,0.4); }
        .save-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* القائمة المنسدلة */
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }
        
        /* Toast */
        .toast { transform: translateY(100px); opacity: 0; transition: all 0.4s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #22c55e; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* أيقونة الكتاب */
        .book-bg { position: absolute; bottom: 20px; left: 20px; opacity: 0.05; font-size: 150px; color: #22c55e; transform: rotate(10deg); pointer-events: none; }
        
        /* شريط التمرير */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 10px; }
        
        /* الجدول */
        .summary-table th { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .summary-table tr:nth-child(even) { background: rgba(22,163,74,0.05); }
        .summary-table tr:hover { background: rgba(22,163,74,0.1); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    
    <!-- الحاوية الرئيسية -->
    <div class="max-w-7xl mx-auto">
        
        <!-- الهيدر -->
        <div class="glass rounded-2xl p-4 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-book-quran text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">القاعدة المدنية</h1>
                    <p class="text-sm text-gray-500">نظام تسجيل الحفظ والمراجعة</p>
                </div>
            </div>
            
            <!-- اختيار التاريخ -->
            <div class="flex items-center gap-3">
                <label class="text-sm font-medium text-gray-600">التاريخ:</label>
                <input type="date" id="selectedDate" class="px-4 py-2 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium">
            </div>
        </div>
        
        <!-- التبويبات -->
        <div class="flex gap-2 mb-6 flex-wrap justify-center">
            <button class="tab-btn active px-6 py-3 rounded-xl font-bold flex items-center gap-2" data-tab="entry" onclick="switchTab('entry')">
                <i class="fas fa-edit"></i>
                <span>الإدخال اليومي</span>
            </button>
            <button class="tab-btn px-6 py-3 rounded-xl font-bold flex items-center gap-2" data-tab="reports" onclick="switchTab('reports')">
                <i class="fas fa-chart-line"></i>
                <span>التقارير</span>
            </button>
            <button class="tab-btn px-6 py-3 rounded-xl font-bold flex items-center gap-2" data-tab="summary" onclick="switchTab('summary')">
                <i class="fas fa-list-check"></i>
                <span>ملخص اليوم</span>
            </button>
        </div>
        
        <!-- محتوى التبويبات -->
        <div id="tabContent">
            
            <!-- ==================== تبويب الإدخال اليومي ==================== -->
            <div id="entryTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <!-- قائمة الطلاب -->
                    <div class="lg:col-span-5">
                        <div class="glass rounded-2xl p-6 relative overflow-hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-users text-primary-500"></i>
                                قائمة الطلاب
                                <span id="studentsCount" class="text-sm font-normal text-gray-500 mr-auto">(0 طالب)</span>
                            </h2>
                            
                            <!-- مؤشر التحميل -->
                            <div id="loadingStudents" class="flex justify-center items-center py-10">
                                <div class="loader"></div>
                                <span class="mr-3 text-gray-500">جاري تحميل البيانات...</span>
                            </div>
                            
                            <!-- شبكة الطلاب -->
                            <div id="studentsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[500px] overflow-y-auto hidden">
                                <!-- سيتم ملؤها بـ JavaScript -->
                            </div>
                            
                            <i class="fas fa-book-open book-bg"></i>
                        </div>
                    </div>
                    
                    <!-- نموذج الإدخال -->
                    <div class="lg:col-span-7">
                        <div class="glass rounded-2xl p-6 relative">
                            
                            <!-- عنوان النموذج -->
                            <div id="formHeader" class="mb-6">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-user-edit text-primary-500"></i>
                                    <span id="formTitle">اختر طالباً للبدء</span>
                                </h2>
                                <p id="formSubtitle" class="text-sm text-gray-500 mt-1">اضغط على اسم الطالب من القائمة</p>
                            </div>
                            
                            <!-- النموذج -->
                            <form id="entryForm" class="space-y-6 hidden">
                                
                                <!-- الحضور -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">
                                        <i class="fas fa-clipboard-check text-primary-500 ml-1"></i>
                                        الحضور
                                    </label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button type="button" class="atte-btn present py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="حاضر" onclick="selectAttendance(this)">
                                            <i class="fas fa-check block text-lg mb-1"></i>
                                            حاضر
                                        </button>
                                        <button type="button" class="atte-btn absent-btn py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="غائب" onclick="selectAttendance(this)">
                                            <i class="fas fa-times block text-lg mb-1"></i>
                                            غائب
                                        </button>
                                        <button type="button" class="atte-btn late py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="متأخر" onclick="selectAttendance(this)">
                                            <i class="fas fa-clock block text-lg mb-1"></i>
                                            متأخر
                                        </button>
                                        <button type="button" class="atte-btn excused py-3 px-2 rounded-xl text-center font-medium text-sm" data-value="مستأذن" onclick="selectAttendance(this)">
                                            <i class="fas fa-hand block text-lg mb-1"></i>
                                            مستأذن
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- قسم الدرجات (يظهر فقط للحاضر/المتأخر) -->
                                <div id="gradesSection" class="space-y-6 hidden">
                                    
                                    <!-- اختيار الدرس -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-3">
                                            <i class="fas fa-book text-primary-500 ml-1"></i>
                                            الدرس
                                        </label>
                                        <select id="lessonSelect" class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium appearance-none">
                                            <option value="">-- اختر الدرس --</option>
                                        </select>
                                    </div>
                                    
                                    <!-- درجة الحفظ -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-3">
                                            <i class="fas fa-brain text-primary-500 ml-1"></i>
                                            درجة الحفظ
                                        </label>
                                        <div class="grid grid-cols-4 gap-2">
                                            <button type="button" class="grade-btn excellent py-3 rounded-xl font-medium text-sm" data-value="10" data-type="save" onclick="selectGrade(this, 'save')">
                                                <span class="block text-lg font-bold">10</span>
                                                ممتاز
                                            </button>
                                            <button type="button" class="grade-btn good py-3 rounded-xl font-medium text-sm" data-value="8" data-type="save" onclick="selectGrade(this, 'save')">
                                                <span class="block text-lg font-bold">8</span>
                                                جيد جداً
                                            </button>
                                            <button type="button" class="grade-btn acceptable py-3 rounded-xl font-medium text-sm" data-value="6" data-type="save" onclick="selectGrade(this, 'save')">
                                                <span class="block text-lg font-bold">6</span>
                                                مقبول
                                            </button>
                                            <button type="button" class="grade-btn weak py-3 rounded-xl font-medium text-sm" data-value="4" data-type="save" onclick="selectGrade(this, 'save')">
                                                <span class="block text-lg font-bold">4</span>
                                                إعادة
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- درجة المراجعة -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-3">
                                            <i class="fas fa-redo text-primary-500 ml-1"></i>
                                            درجة المراجعة
                                        </label>
                                        <div class="grid grid-cols-4 gap-2">
                                            <button type="button" class="grade-btn excellent py-3 rounded-xl font-medium text-sm" data-value="10" data-type="review" onclick="selectGrade(this, 'review')">
                                                <span class="block text-lg font-bold">10</span>
                                                ممتاز
                                            </button>
                                            <button type="button" class="grade-btn good py-3 rounded-xl font-medium text-sm" data-value="8" data-type="review" onclick="selectGrade(this, 'review')">
                                                <span class="block text-lg font-bold">8</span>
                                                جيد جداً
                                            </button>
                                            <button type="button" class="grade-btn acceptable py-3 rounded-xl font-medium text-sm" data-value="6" data-type="review" onclick="selectGrade(this, 'review')">
                                                <span class="block text-lg font-bold">6</span>
                                                مقبول
                                            </button>
                                            <button type="button" class="grade-btn weak py-3 rounded-xl font-medium text-sm" data-value="4" data-type="review" onclick="selectGrade(this, 'review')">
                                                <span class="block text-lg font-bold">4</span>
                                                إعادة
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- النقاط -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-3">
                                            <i class="fas fa-star text-gold-500 ml-1"></i>
                                            نقاط التحفيز
                                        </label>
                                        <input type="number" id="pointsInput" min="0" max="100" value="0" class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium text-center text-xl">
                                    </div>
                                    
                                    <!-- الملاحظات -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-3">
                                            <i class="fas fa-comment text-primary-500 ml-1"></i>
                                            ملاحظات
                                        </label>
                                        <textarea id="notesInput" rows="2" placeholder="أضف ملاحظات (اختياري)..." class="w-full py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition resize-none"></textarea>
                                    </div>
                                </div>
                                
                                <!-- زر الحفظ -->
                                <button type="submit" id="saveBtn" class="save-btn w-full py-4 rounded-xl text-white font-bold text-lg flex items-center justify-center gap-2" disabled>
                                    <i class="fas fa-save"></i>
                                    <span>حفظ البيانات</span>
                                </button>
                            </form>
                            
                            <!-- رسالة اختيار طالب -->
                            <div id="selectPrompt" class="text-center py-16">
                                <i class="fas fa-hand-pointer text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-400 text-lg">اختر طالباً من القائمة للبدء بالتسجيل</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== تبويب التقارير ==================== -->
            <div id="reportsTab" class="tab-content hidden">
                <div class="glass rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-chart-line text-primary-500"></i>
                            تقارير الطلاب
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="exportReports('pdf')" class="px-4 py-2 bg-red-500 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-red-600 transition">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button onclick="exportReports('excel')" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-green-700 transition">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- اختيار الطالب للتقرير -->
                    <div class="mb-6">
                        <select id="reportStudentSelect" onchange="loadStudentReport()" class="w-full md:w-64 py-3 px-4 rounded-xl border-2 border-gray-200 focus:border-primary-500 outline-none transition font-medium appearance-none">
                            <option value="">-- اختر طالباً --</option>
                        </select>
                    </div>
                    
                    <!-- الرسم البياني -->
                    <div id="reportChartContainer" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-gray-700 mb-4">تقدم الحفظ والمراجعة</h3>
                                <canvas id="progressChart" height="250"></canvas>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-gray-700 mb-4">نسبة الحضور</h3>
                                <canvas id="attendanceChart" height="250"></canvas>
                            </div>
                        </div>
                        
                        <!-- إحصائيات سريعة -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-calendar-check text-3xl text-primary-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statAttendance">--%</p>
                                <p class="text-sm text-gray-500">نسبة الحضور</p>
                            </div>
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-brain text-3xl text-blue-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statSave">--</p>
                                <p class="text-sm text-gray-500">متوسط الحفظ</p>
                            </div>
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-redo text-3xl text-purple-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statReview">--</p>
                                <p class="text-sm text-gray-500">متوسط المراجعة</p>
                            </div>
                            <div class="glass-card rounded-2xl p-4 text-center">
                                <i class="fas fa-star text-3xl text-gold-500 mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800" id="statPoints">--</p>
                                <p class="text-sm text-gray-500">مجموع النقاط</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noReportData" class="text-center py-16">
                        <i class="fas fa-chart-pie text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-400 text-lg">اختر طالباً لعرض تقريره</p>
                    </div>
                </div>
            </div>
            
            <!-- ==================== تبويب ملخص اليوم ==================== -->
            <div id="summaryTab" class="tab-content hidden">
                <div class="glass rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-list-check text-primary-500"></i>
                            ملخص اليوم
                            <span id="summaryDate" class="text-sm font-normal text-gray-500"></span>
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="exportSummary('pdf')" class="px-4 py-2 bg-red-500 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-red-600 transition">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button onclick="exportSummary('excel')" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium flex items-center gap-2 hover:bg-green-700 transition">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- إحصائيات سريعة -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="glass-card rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-primary-600" id="summaryTotal">0</p>
                            <p class="text-xs text-gray-500">إجمالي الطلاب</p>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-green-600" id="summaryPresent">0</p>
                            <p class="text-xs text-gray-500">حاضر</p>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-red-500" id="summaryAbsent">0</p>
                            <p class="text-xs text-gray-500">غائب</p>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-yellow-500" id="summaryLate">0</p>
                            <p class="text-xs text-gray-500">متأخر</p>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-purple-500" id="summaryExcused">0</p>
                            <p class="text-xs text-gray-500">مستأذن</p>
                        </div>
                    </div>
                    
                    <!-- جدول الملخص -->
                    <div class="overflow-x-auto">
                        <table class="summary-table w-full rounded-xl overflow-hidden">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-right">الطالب</th>
                                    <th class="py-3 px-4 text-center">الحضور</th>
                                    <th class="py-3 px-4 text-right">الدرس</th>
                                    <th class="py-3 px-4 text-center">الحفظ</th>
                                    <th class="py-3 px-4 text-center">المراجعة</th>
                                    <th class="py-3 px-4 text-center">النقاط</th>
                                    <th class="py-3 px-4 text-right">ملاحظات</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                                <tr>
                                    <td colspan="7" class="py-10 text-center text-gray-400">
                                        <i class="fas fa-inbox text-4xl mb-2 block"></i>
                                        لا توجد بيانات مسجلة اليوم
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast الإشعارات -->
    <div id="toast" class="toast fixed bottom-6 left-6 right-6 md:left-auto md:right-6 md:w-96 bg-primary-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 z-50">
        <i id="toastIcon" class="fas fa-check-circle text-2xl"></i>
        <span id="toastMessage" class="font-medium">تم الحفظ بنجاح</span>
    </div>
    
    <!-- ==================== JavaScript ==================== -->
    <script>
        // ==================== المتغيرات العامة ====================
        // Production URLs - تأكد أن الـ Workflows مفعّلة في n8n
        const API_BASE = 'https://n8n.srv1238717.hstgr.cloud/webhook';
        const GET_DATA_URL = `${API_BASE}/Get-data`;
        const SUBMIT_URL = `${API_BASE}/Submit-daily`;
        
        // ملاحظة: هذه الروابط الإنتاجية، يجب تفعيل الـ Workflows في n8n
        
        let students = [];
        let lessons = [];
        let selectedStudent = null;
        let todayRecords = []; // سجلات اليوم
        
        let formData = {
            attendance: null,
            lesson: null,
            saveScore: null,
            reviewScore: null,
            points: 0,
            notes: ''
        };
        
        // ==================== تهيئة التطبيق ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // تعيين تاريخ اليوم
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectedDate').value = today;
            
            // تحميل البيانات
            await loadData();
            
            // إعداد النموذج
            document.getElementById('entryForm').addEventListener('submit', handleSubmit);
        });
        
        // ==================== تحميل البيانات من n8n ====================
        async function loadData() {
            try {
                const response = await fetch(GET_DATA_URL);
                const data = await response.json();
                
                // فصل الطلاب والدروس
                students = data.filter(item => item.Student_na);
                lessons = data.filter(item => item.lesson_name);
                
                // عرض الطلاب
                renderStudents();
                
                // ملء قائمة الدروس
                populateLessons();
                
                // ملء قائمة التقارير
                populateReportStudents();
                
                // تحديث العداد
                document.getElementById('studentsCount').textContent = `(${students.length} طالب)`;
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showToast('فشل تحميل البيانات', 'error');
            }
        }
        
        // ==================== عرض الطلاب ====================
        function renderStudents() {
            const grid = document.getElementById('studentsGrid');
            const loading = document.getElementById('loadingStudents');
            
            loading.classList.add('hidden');
            grid.classList.remove('hidden');
            
            grid.innerHTML = students.map(student => {
                const record = todayRecords.find(r => r.student_na === student.Student_na);
                let statusClass = '';
                let statusIcon = '';
                
                if (record) {
                    if (record.atte === 'غائب') {
                        statusClass = 'absent';
                        statusIcon = '<i class="fas fa-times-circle text-red-500 absolute top-1 left-1"></i>';
                    } else {
                        statusClass = 'recorded';
                        statusIcon = '<i class="fas fa-check-circle text-yellow-500 absolute top-1 left-1"></i>';
                    }
                }
                
                return `
                    <div class="student-card glass-card rounded-xl p-4 cursor-pointer text-center relative ${statusClass} ${selectedStudent?.id === student.id ? 'selected' : ''}" 
                         onclick="selectStudent(${student.id})">
                        ${statusIcon}
                        <div class="w-12 h-12 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold text-lg">
                            ${student.Student_na.charAt(0)}
                        </div>
                        <p class="font-bold text-gray-800 text-sm truncate">${student.Student_na}</p>
                        <p class="text-xs text-gray-500">${student.Student_lev || 'مبتدئ'}</p>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== ملء قائمة الدروس ====================
        function populateLessons() {
            const select = document.getElementById('lessonSelect');
            select.innerHTML = '<option value="">-- اختر الدرس --</option>' + 
                lessons.map(lesson => `
                    <option value="${lesson.lesson_name}">${lesson.lesson_name} (ص${lesson.page_number})</option>
                `).join('');
        }
        
        // ==================== ملء قائمة طلاب التقارير ====================
        function populateReportStudents() {
            const select = document.getElementById('reportStudentSelect');
            select.innerHTML = '<option value="">-- اختر طالباً --</option>' + 
                students.map(student => `
                    <option value="${student.Student_na}">${student.Student_na}</option>
                `).join('');
        }
        
        // ==================== اختيار طالب ====================
        function selectStudent(id) {
            selectedStudent = students.find(s => s.id === id);
            
            // تحديث الواجهة
            document.getElementById('formTitle').textContent = selectedStudent.Student_na;
            document.getElementById('formSubtitle').textContent = `المستوى: ${selectedStudent.Student_lev || 'مبتدئ'}`;
            
            // إظهار النموذج
            document.getElementById('selectPrompt').classList.add('hidden');
            document.getElementById('entryForm').classList.remove('hidden');
            
            // إعادة تعيين النموذج
            resetForm();
            
            // تحديث بطاقات الطلاب
            renderStudents();
        }
        
        // ==================== اختيار الحضور ====================
        function selectAttendance(btn) {
            // إزالة التحديد السابق
            document.querySelectorAll('.atte-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            formData.attendance = btn.dataset.value;
            
            // إظهار/إخفاء قسم الدرجات
            const gradesSection = document.getElementById('gradesSection');
            if (formData.attendance === 'حاضر' || formData.attendance === 'متأخر') {
                gradesSection.classList.remove('hidden');
            } else {
                gradesSection.classList.add('hidden');
            }
            
            validateForm();
        }
        
        // ==================== اختيار الدرجة ====================
        function selectGrade(btn, type) {
            // إزالة التحديد من نفس النوع
            document.querySelectorAll(`.grade-btn[data-type="${type}"]`).forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            if (type === 'save') {
                formData.saveScore = parseInt(btn.dataset.value);
            } else {
                formData.reviewScore = parseInt(btn.dataset.value);
            }
            
            validateForm();
        }
        
        // ==================== التحقق من صحة النموذج ====================
        function validateForm() {
            const saveBtn = document.getElementById('saveBtn');
            let isValid = false;
            
            if (formData.attendance === 'غائب' || formData.attendance === 'مستأذن') {
                isValid = true;
            } else if (formData.attendance === 'حاضر' || formData.attendance === 'متأخر') {
                const lesson = document.getElementById('lessonSelect').value;
                isValid = lesson && formData.saveScore && formData.reviewScore;
            }
            
            saveBtn.disabled = !isValid;
        }
        
        // ==================== إرسال البيانات ====================
        async function handleSubmit(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="loader mx-auto"></div>';
            
            const payload = {
                student_na: selectedStudent.Student_na,
                lesson_na: document.getElementById('lessonSelect').value || '',
                save_sc: formData.saveScore || 0,
                review_sc: formData.reviewScore || 0,
                points: parseInt(document.getElementById('pointsInput').value) || 0,
                atte: formData.attendance,
                notes: document.getElementById('notesInput').value,
                date: document.getElementById('selectedDate').value
            };
            
            try {
                const response = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    // إضافة للسجلات المحلية
                    todayRecords.push(payload);
                    
                    showToast('تم حفظ البيانات بنجاح ✓', 'success');
                    
                    // تحديث الملخص
                    updateSummary();
                    
                    // تحديث بطاقات الطلاب
                    renderStudents();
                    
                    // إعادة تعيين النموذج
                    resetForm();
                    selectedStudent = null;
                    document.getElementById('selectPrompt').classList.remove('hidden');
                    document.getElementById('entryForm').classList.add('hidden');
                    document.getElementById('formTitle').textContent = 'اختر طالباً للبدء';
                    document.getElementById('formSubtitle').textContent = 'اضغط على اسم الطالب من القائمة';
                    
                } else {
                    showToast('فشل حفظ البيانات', 'error');
                }
            } catch (error) {
                console.error('خطأ:', error);
                showToast('خطأ في الاتصال', 'error');
            }
            
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i><span>حفظ البيانات</span>';
        }
        
        // ==================== إعادة تعيين النموذج ====================
        function resetForm() {
            formData = { attendance: null, lesson: null, saveScore: null, reviewScore: null, points: 0, notes: '' };
            
            document.querySelectorAll('.atte-btn, .grade-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('lessonSelect').value = '';
            document.getElementById('pointsInput').value = '0';
            document.getElementById('notesInput').value = '';
            document.getElementById('gradesSection').classList.add('hidden');
            document.getElementById('saveBtn').disabled = true;
        }
        
        // ==================== تحديث الملخص ====================
        function updateSummary() {
            const date = document.getElementById('selectedDate').value;
            document.getElementById('summaryDate').textContent = `- ${date}`;
            
            const dateRecords = todayRecords.filter(r => r.date === date);
            
            // الإحصائيات
            document.getElementById('summaryTotal').textContent = students.length;
            document.getElementById('summaryPresent').textContent = dateRecords.filter(r => r.atte === 'حاضر').length;
            document.getElementById('summaryAbsent').textContent = dateRecords.filter(r => r.atte === 'غائب').length;
            document.getElementById('summaryLate').textContent = dateRecords.filter(r => r.atte === 'متأخر').length;
            document.getElementById('summaryExcused').textContent = dateRecords.filter(r => r.atte === 'مستأذن').length;
            
            // الجدول
            const tbody = document.getElementById('summaryTableBody');
            if (dateRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-10 text-center text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-2 block"></i>
                            لا توجد بيانات مسجلة اليوم
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = dateRecords.map(r => {
                    let atteClass = '';
                    if (r.atte === 'حاضر') atteClass = 'text-green-600 bg-green-100';
                    else if (r.atte === 'غائب') atteClass = 'text-red-600 bg-red-100';
                    else if (r.atte === 'متأخر') atteClass = 'text-yellow-600 bg-yellow-100';
                    else atteClass = 'text-purple-600 bg-purple-100';
                    
                    return `
                        <tr>
                            <td class="py-3 px-4 font-medium">${r.student_na}</td>
                            <td class="py-3 px-4 text-center"><span class="px-3 py-1 rounded-full text-sm ${atteClass}">${r.atte}</span></td>
                            <td class="py-3 px-4 text-sm">${r.lesson_na || '-'}</td>
                            <td class="py-3 px-4 text-center font-bold">${r.save_sc || '-'}</td>
                            <td class="py-3 px-4 text-center font-bold">${r.review_sc || '-'}</td>
                            <td class="py-3 px-4 text-center"><span class="text-yellow-600 font-bold">${r.points}</span></td>
                            <td class="py-3 px-4 text-sm text-gray-500">${r.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        // ==================== التبديل بين التبويبات ====================
        function switchTab(tab) {
            // تحديث الأزرار
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) btn.classList.add('active');
            });
            
            // إخفاء الكل
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // إظهار المحدد
            document.getElementById(`${tab}Tab`).classList.remove('hidden');
            
            // تحديث البيانات حسب التبويب
            if (tab === 'summary') updateSummary();
        }
        
        // ==================== تحميل تقرير الطالب ====================
        function loadStudentReport() {
            const studentName = document.getElementById('reportStudentSelect').value;
            const container = document.getElementById('reportChartContainer');
            const noData = document.getElementById('noReportData');
            
            if (!studentName) {
                container.classList.add('hidden');
                noData.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noData.classList.add('hidden');
            
            // بيانات تجريبية للرسم البياني
            const ctx1 = document.getElementById('progressChart').getContext('2d');
            const ctx2 = document.getElementById('attendanceChart').getContext('2d');
            
            // تدمير الرسوم السابقة
            Chart.getChart(ctx1)?.destroy();
            Chart.getChart(ctx2)?.destroy();
            
            // رسم التقدم
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['الأسبوع 1', 'الأسبوع 2', 'الأسبوع 3', 'الأسبوع 4'],
                    datasets: [
                        { label: 'الحفظ', data: [7, 8, 8, 9], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.4 },
                        { label: 'المراجعة', data: [6, 7, 8, 8], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { min: 0, max: 10 } } }
            });
            
            // رسم الحضور
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['حاضر', 'غائب', 'متأخر', 'مستأذن'],
                    datasets: [{ data: [18, 1, 2, 1], backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#8b5cf6'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
            
            // الإحصائيات
            document.getElementById('statAttendance').textContent = '90%';
            document.getElementById('statSave').textContent = '8.2';
            document.getElementById('statReview').textContent = '7.8';
            document.getElementById('statPoints').textContent = '45';
        }
        
        // ==================== تصدير التقارير ====================
        function exportReports(format) {
            showToast(`جاري تصدير التقرير بصيغة ${format.toUpperCase()}...`, 'info');
            // TODO: تنفيذ التصدير الفعلي
        }
        
        function exportSummary(format) {
            showToast(`جاري تصدير الملخص بصيغة ${format.toUpperCase()}...`, 'info');
            // TODO: تنفيذ التصدير الفعلي
        }
        
        // ==================== إظهار الإشعارات ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            msg.textContent = message;
            
            // تغيير اللون والأيقونة
            toast.className = 'toast fixed bottom-6 left-6 right-6 md:left-auto md:right-6 md:w-96 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 z-50';
            
            if (type === 'success') {
                toast.classList.add('bg-primary-500');
                icon.className = 'fas fa-check-circle text-2xl';
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
                icon.className = 'fas fa-times-circle text-2xl';
            } else {
                toast.classList.add('bg-blue-500');
                icon.className = 'fas fa-info-circle text-2xl';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // ==================== مراقبة تغيير الدرس ====================
        document.getElementById('lessonSelect')?.addEventListener('change', validateForm);
    </script>
</body>
</html>